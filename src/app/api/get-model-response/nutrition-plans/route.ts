import { saveUserPreferences, saveNutritionRecommendations } from "@/server/saveFunctions";
import { NextRequest, NextResponse } from "next/server";

export async function POST(req: NextRequest) {
  try {
    const { userId, answers, userStats } = await req.json();

    if (!userId || !answers) {
      return NextResponse.json({ error: "User id and answers are required" }, { status: 400 });
    }

    saveUserPreferences(userId, "nutrition", answers);

    const systemPrompt = generateSystemPrompt();
    const userPrompt = generateUserPrompt(answers, userStats);
    const responseFormat = generateResponseFormat();

    const response = await fetch("https://api.openai.com/v1/responses", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "gpt-5.2",
        input: [
          {
            role: "system",
            content: systemPrompt,
          },
          {
            role: "user",
            content: userPrompt,
          },
        ],
        text: responseFormat,
      }),
    });

    if (!response.ok) {
      throw new Error(`OpenAI API error: ${response.statusText}`);
    }

    const data = await response.json();
    const nutritionRecommendations = data.output[0].content[0].text;

    const nutritionPlanParsed = JSON.parse(nutritionRecommendations);
    saveNutritionRecommendations(userId, nutritionPlanParsed);

    return NextResponse.json(nutritionRecommendations);
  } catch (error) {
    console.error("Error generating recommendations:", error);
    return NextResponse.json({ error: "Failed to generate recommendations" }, { status: 500 });
  }
}

function generateSystemPrompt(): string {
  return `Ти си професионален диетолог. Задачата ти е да създаваш персонализирани хранителни планове на база предоставените данни за потребителя. 
          Винаги отговаряй САМО с валиден JSON формат, без допълнителен текст или markdown.
          КРИТИЧНО ВАЖНО - Адаптивна структура на хранителния план:
            - Създавай естествена структура на хранения според времето на тренировка
            - Ако тренировката е СУТРИН: Първото хранене може да е предтренировъчно, следвано от следтренировъчно
            - Ако тренировката е по-късно: Започни с нормална закуска и разположи предтренировъчното и следтренировъчното хранене около времето на тренировка
            - Винаги включвай основните хранения: закуска, обяд, вечеря (освен ако не са заменени от тренировъчни хранения)
            - Добави междинни закуски според нуждата за достигане на дневните макроси
        `;
}

function generateUserPrompt(answers: Record<string, any>, userStats?: any): string {
  const trainingTime = answers.trainingTime || "afternoon";

  const trainingPeriodMap: Record<string, string> = {
    morning: "сутрин (06:00-09:00)",
    "before-noon": "преди обед (09:00-12:00)",
    noon: "на обяд (12:00-14:00)",
    afternoon: "следобед (14:00-17:00)",
    evening: "вечер (17:00-21:00)",
  };

  const trainingPeriodBG = trainingPeriodMap[trainingTime] || "следобед";

  return `Създай персонализиран седмичен хранителен план за потребител със следните характеристики:

        **Лични данни:**
        - Пол: ${userStats?.gender || "не е посочен"}
        - Височина: ${userStats?.height || "не е посочена"} см
        - Тегло: ${userStats?.weight || "не е посочено"} кг
        - Възраст: ${userStats?.age || "не е посочена"} години
        - BMI: ${userStats?.bmi || "не е изчислен"}
        - Body Fat: ${userStats?.bodyFat || "не е изчислен"}%
        - Маса на телесните мазнини: ${userStats?.bodyFatMass || "не е изчислена"} кг
        - Чиста телесна маса: ${userStats?.leanBodyMass || "не е изчислена"} кг
        
        **Хранителни предпочитания и цели:**
        - Основна цел: ${answers.mainGoal || "не е посочена"}
        - Период от деня, в който потребителя тренира: ${trainingPeriodBG}
        - Целево тегло: ${answers.targetWeight === "yes" ? answers.targetWeightValue + " кг" : "не е посочено"}
        - Здравословни проблеми или алергии: ${answers.healthIssues || "Няма"}
        - Предпочитани кухни: ${answers.cuisinePreference?.join(", ") || "Нямам предпочитания"}

        **ДНЕВНИ МАКРОНУТРИЕНТНИ ЦЕЛИ (СТРОГИ):**
        - Калории: ${answers.calories} kcal (допустим диапазон: ${answers.calories - 50} - ${answers.calories + 50} kcal)
        - Протеини: ${answers.protein}g (допустим диапазон: ${answers.protein - 10} - ${answers.protein + 10}g)
        - Въглехидрати: ${answers.carbs}g (допустим диапазон: ${answers.carbs - 15} - ${answers.carbs + 15}g)
        - Мазнини: ${answers.fats}g (допустим диапазон: ${answers.fats - 10} - ${answers.fats + 10}g)
        
        **СТРУКТУРА НА ХРАНИТЕЛНИЯ ПЛАН:**
        Като имаш предвид, че потребителят тренира ${trainingPeriodBG}, осигури:
        - Закуска (освен ако тренировката е сутрин - тогава закуската е след тренировката)
        - Обяд
        - Вечеря
        - Задължително предтренировъчно хранене 
        - Задължително следтренировъчно хранене
        - 1-2 междинни закуски според нуждата за покриване на дневните калории

        Подреди храненията естествено според времето на деня и тренировката. Времената на храненията трябва да са логични и последователни през деня.

        **РАЗНООБРАЗИЕ В МАКРОСИТЕ:**
        
        Забранено е да използваш същите или почти идентични макроси за едно и също хранене във всички дни от седмицата.
        
        **Принципи за разнообразие:**
        
        1. **ВАРИРАЙ КАЛОРИИТЕ ПО ХРАНЕНИЯ (не по дни):**
           - Закуската в Ден 1 може да е 600 kcal, но в Ден 2 да е 750 kcal, а в Ден 3 - 550 kcal
           - Обядът в Ден 1 може да е 700 kcal, но в Ден 2 да е 550 kcal, а в Ден 3 - 800 kcal
           - Създай естествено разнообразие - различни порции, различни съставки, различни стилове.
        
        2. **БАЛАНС МЕЖДУ КОМПЕНСАЦИЯ:**
           - Ако закуската е по-малка (500 kcal), обядът може да е по-голям (750 kcal)
           - Ако обядът е по-богат (800 kcal), вечерята може да е по-лека (450 kcal)
           - Всеки ден трябва да има различна комбинация и баланс
        
        **Важни насоки за хранителния план:**

        **Общи правила:**
        - Разпредели храненията през деня така, че да се покрият дневните нутриенти (${answers.calories} kcal, ${answers.protein}g протеини, ${answers.carbs}g въглехидрати, ${answers.fats}g мазнини)
        - Всяко хранене трябва да има точни порции и грамаж на съставките
        - СПАЗВАЙ ПРЕДПОЧИТАНИТЕ КУХНИ:** ${answers.cuisinePreference?.join(", ") || "разнообразни"}
          * Използвай типични съставки, подправки и начини на готвене от избраните кухни
          * Ако няма предпочитание - използвай разнообразие от различни кухни през седмицата
          * Всяко хранене трябва да отразява избраната кухня в съставките, подправките и начина на приготвяне
        - Вземи предвид здравословните проблеми/алергии: ${answers.healthIssues}
        - ИЗБЯГВАЙ повторение на идентични макроси за същото хранене в различни дни, целиш точна и вярна информация.

        **Специфични насоки според целта:**
        - При цел 'cut' (-500 cal дефицит, 40P/25F/35C): Фокусирай се върху високопротеинови храни за запазване на мускулна маса, зеленчуци с ниско съдържание на въглехидрати, умерени здравословни мазнини. Цел: загуба на 0.5 кг седмично.
        - При цел 'aggressive_cut' (-750 cal дефицит, 45P/20F/35C): Максимизирай протеините (45% от калориите) за запазване на мускулите при агресивен дефицит. Минимизирай мазнините (20%), фокус върху сложни въглехидрати. Избягвай прости захари и рафинирани храни. Цел: загуба на 0.75 кг седмично.
        - При цел 'lean_bulk' (+300 cal суфицит, 30P/25F/45C): Контролиран суфицит за постепенно качване на чиста мускулна маса. Акцент върху качествени протеини и сложни въглехидрати (45%). Избягвай прекомерно мазни и преработени храни. Цел: бавно и качествено покачване.
        - При цел 'dirty_bulk' (+500 cal суфицит, 25P/30F/45C): По-висок калориен прием за максимално бързо покачване на маса. Допустими са по-мазни храни (30%) и по-големи порции. Фокус върху достигане на калориите, дори с по-малко "чисти" храни.
        - При цел 'recomposition' (-200 cal леко под поддръжка, 40P/30F/30C): Балансиран подход с висок протеин (40%) за едновременна загуба на мазнини и качване на мускули. Балансирани мазнини (30%) и въглехидрати (30%). Качествени храни с акцент върху хранителна плътност.
        - При цел 'maintenance' (0 cal, 30P/30F/40C): Балансирани макроси за поддържане на текущото тегло и форма. Равномерно разпределение между протеини, мазнини и въглехидрати. Фокус върху дългосрочна устойчивост.
        - При цел 'aesthetic' (-300 cal умерен дефицит, 40P/25F/35C): Висок протеинов прием (40%) за запазване на мускулната маса при дефицит. Умерени мазнини (25%) и въглехидрати (35%). Фокус върху постни протеини, сложни въглехидрати и естетичен външен вид.
        - При цел 'strength' (+200 cal леко над поддръжка, 30P/25F/45C): Достатъчно въглехидрати (45%) за енергия и силови показатели. Умерен протеинов прием (30%) за възстановяване. Калориен суфицит за подкрепа на интензивни тренировки със свободни тежести.

        **Важни правила за предтренировъчни и следтренировъчни храни:**
        - Предтренировъчното хранене (pre_workout_snack):
        * Трябва да е 45-90 минути ПРЕДИ тренировката
        * Съдържа лесно смилаеми въглехидрати (например: банани, овесена каша, ориз)
        * Умерени протеини (например: протеинов шейк, яйца)
        * Ниско съдържание на мазнини и фибри
        * Порции: 200-400 kcal, 15-25g протеини, 30-50g въглехидрати
        
        - Следтренировъчното хранене (post_workout_snack):
        * Трябва да е 30-60 минути СЛЕД тренировката
        * Високо съдържание на протеини за възстановяване (30-40g)
        * Бързо усвоими въглехидрати за попълване на гликогена (40-60g)
        * Примери: пилешко филе с ориз, протеинов шейк с банан, риба с картофи
        * Порции: 400-600 kcal, 30-40g протеини, 40-60g въглехидрати

        **КРИТИЧНО ВАЖНО - ИЗЧИСЛЯВАНЕ НА МАКРОСИ:**

        МАКРОСИТЕ ТРЯБВА ДА СЕ ИЗЧИСЛЯВАТ ВЪЗ ОСНОВА НА РЕАЛНИТЕ ХРАНИТЕЛНИ СТОЙНОСТИ НА СЪСТАВКИТЕ!
        
        **Как да изчисляваш макросите ПРАВИЛНО:**
        
        1. **ЗА ВСЯКА СЪСТАВКА** използвай реалните хранителни стойности на 100г:
           
           **ВАЖНО:** Стойностите по-долу са за СУРОВА храна, освен където е отбелязано "готвено/варено".
           
           ПРОТЕИНОВИ ИЗТОЧНИЦИ (на 100г):
           - Пилешко филе (сурово): 120 kcal, 23g протеин, 0g въглехидрати, 2.6g мазнини
           - Пилешко филе (готвено/печено): 165 kcal, 31g протеин, 0g въглехидрати, 3.6g мазнини
           - Пилешко бутче (с кожа, готвено): 209 kcal, 26g протеин, 0g въглехидрати, 11g мазнини
           - Пилешко бутче (без кожа, готвено): 180 kcal, 25g протеин, 0g въглехидрати, 8g мазнини
           - Свинско месо (постно): 143 kcal, 20g протеин, 0g въглехидрати, 7g мазнини
           - Телешко месо (постно): 150 kcal, 26g протеин, 0g въглехидрати, 5g мазнини
           - Пуешко филе (сурово): 111 kcal, 24g протеин, 0g въглехидрати, 1.5g мазнини
           - Сьомга (сурова, отглеждана): 206 kcal, 22g протеин, 0g въглехидрати, 13g мазнини
           - Риба тон (сурова): 130 kcal, 28g протеин, 0g въглехидрати, 1g мазнини
           - Риба тилапия (сурова): 96 kcal, 20g протеин, 0g въглехидрати, 1.7g мазнини
           - Яйца (сурови, цели): 143 kcal, 12.6g протеин, 0.7g въглехидрати, 9.5g мазнини
           - Извара (1% мазнини): 72 kcal, 12g протеин, 2.7g въглехидрати, 2g мазнини
           - Извара (обезмаслена): 80 kcal, 16g протеин, 3g въглехидрати, 0.5g мазнини
           - Гръцки йогурт (пълномаслен): 97 kcal, 9g протеин, 4g въглехидрати, 5g мазнини
           - Гръцки йогурт (обезмаслен): 59 kcal, 10g протеин, 3.6g въглехидрати, 0.4g мазнини
           - Протеинов прах (whey): 390 kcal, 80g протеин, 8g въглехидрати, 4g мазнини
           
           ВЪГЛЕХИДРАТНИ ИЗТОЧНИЦИ (на 100г):
           - Ориз (бял, варен): 130 kcal, 2.7g протеин, 28g въглехидрати, 0.3g мазнини
           - Ориз (кафяв, варен): 112 kcal, 2.6g протеин, 24g въглехидрати, 0.9g мазнини
           - Овесени ядки (сурови): 389 kcal, 17g протеин, 66g въглехидрати, 7g мазнини
           - Картофи (варени): 77 kcal, 2g протеин, 17g въглехидрати, 0.1g мазнини
           - Сладки картофи (варени): 86 kcal, 1.6g протеин, 20g въглехидрати, 0.1g мазнини
           - Паста (варена): 131 kcal, 5g протеин, 25g въглехидрати, 1g мазнини
           - Хляб (пълнозърнест): 247 kcal, 13g протеин, 41g въглехидрати, 3g мазнини
           - Хляб (бял): 266 kcal, 9g протеин, 49g въглехидрати, 3.2g мазнини
           - Киноа (варено): 120 kcal, 4.4g протеин, 21g въглехидрати, 1.9g мазнини
           - Леща (варена): 116 kcal, 9g протеин, 20g въглехидрати, 0.4g мазнини
           - Нахут (варен): 164 kcal, 9g протеин, 27g въглехидрати, 2.6g мазнини
           - Банан: 89 kcal, 1.1g протеин, 23g въглехидрати, 0.3g мазнини
           - Ябълка: 52 kcal, 0.3g протеин, 14g въглехидрати, 0.2g мазнини
           - Тиква: 26 kcal, 1g протеин, 6g въглехидрати, 0.1g мазнини
           
           ЗЕЛЕНЧУЦИ (на 100г, сурови):
           - Броколи: 34 kcal, 2.8g протеин, 7g въглехидрати, 0.4g мазнини
           - Спанак: 23 kcal, 2.9g протеин, 3.6g въглехидрати, 0.4g мазнини
           - Чушки (червени): 31 kcal, 1g протеин, 6g въглехидрати, 0.3g мазнини
           - Домати: 18 kcal, 0.9g протеин, 3.9g въглехидрати, 0.2g мазнини
           - Краставици: 15 kcal, 0.7g протеин, 3.6g въглехидрати, 0.1g мазнини
           - Моркови: 41 kcal, 0.9g протеин, 10g въглехидрати, 0.2g мазнини
           - Зелена салата: 15 kcal, 1.4g протеин, 2.9g въглехидрати, 0.2g мазнини
           
           МАЗНИНИ (на 100г):
           - Зехтин: 884 kcal, 0g протеин, 0g въглехидрати, 100g мазнини
           - Бадеми: 579 kcal, 21g протеин, 22g въглехидрати, 50g мазнини
           - Орехи: 654 kcal, 15g протеин, 14g въглехидрати, 65g мазнини
           - Кашу: 553 kcal, 18g протеин, 30g въглехидрати, 44g мазнини
           - Авокадо: 160 kcal, 2g протеин, 9g въглехидрати, 15g мазнини
           - Тахан: 595 kcal, 17g протеин, 21g въглехидрати, 54g мазнини
           - Фъстъчено масло: 588 kcal, 25g протеин, 20g въглехидрати, 50g мазнини
           - Семена от чиа: 486 kcal, 17g протеин, 42g въглехидрати, 31g мазнини
           - Слънчогледови семки: 584 kcal, 21g протеин, 20g въглехидрати, 51g мазнини
        
        2. **ИЗЧИСЛИ МАКРОСИТЕ** за всяка съставка въз основа на грамажа:
           Пример: 200г пилешко филе (сурово) = (200/100) × стойности за 100г
           = 200/100 × (120 kcal, 23g P, 0g C, 2.6g F)
           = 240 kcal, 46g протеин, 0g въглехидрати, 5.2g мазнини
        
        3. **СЪБЕРИ ВСИЧКИ СЪСТАВКИ** за да получиш общите макроси на храненето
        
        4. **ПРОВЕРИ МАТЕМАТИКАТА**: (protein × 4) + (carbs × 4) + (fats × 9) ≈ calories (±5% толеранс)
        
        **ЗАДЪЛЖИТЕЛНИ ВАЛИДАЦИОННИ ПРОВЕРКИ ПРЕДИ ГЕНЕРИРАНЕ:**
        ЗА ВСЯКО ХРАНЕНЕ провери:
        1. calories > 0 AND calories >= 100 AND calories <= 1000
        2. protein > 0 AND protein >= 5
        3. carbs >= 0 (може да е 0 за кето храна)
        4. fats > 0 AND fats >= 2
        5. (protein × 4) + (carbs × 4) + (fats × 9) = calories (±10% толеранс)
        
        ЗА ВСЕКИ ДЕН провери:
        1. Сума от калориите на всички хранения = ${answers.calories} kcal (±50 kcal)
        2. Сума от протеините = ${answers.protein}g (±10g)
        3. Сума от въглехидратите = ${answers.carbs}g (±15g)
        4. Сума от мазнините = ${answers.fats}g (±10g)
        5. Задължително 1 pre_workout_snack и 1 post_workout_snack
        6. Времената на храненията са последователни с минимум 2 часа разлика
        
        ЗА РАЗНООБРАЗИЕ:
        1. Закуските в различните дни НЕ трябва да имат идентични калории (варирай ±100 kcal)
        2. Обедите в различните дни НЕ трябва да имат идентични калории (варирай ±150 kcal)
        3. Вечерите в различните дни НЕ трябва да имат идентични калории (варирай ±100 kcal)
        4. Предтренировъчните хранения - варирай между 250-350 kcal
        5. Следтренировъчните хранения - варирай между 500-650 kcal
        
        АКО НЯКОЯ ПРОВЕРКА НЕ МИНАВА - КОРИГИРАЙ ПРЕДИ ДА ПРОДЪЛЖИШ!

        **Формат на отговора:**
        - meal_id: Уникален идентификатор за рецептата във формат малки букви с долни черти, винаги на английски език (например: "oatmeal_protein_blueberries", "chicken_rice_broccoli", "tuna_salad_olive_oil"). ВИНАГИ в единствено число.
        - name: Име на рецептата на БЪЛГАРСКИ (например: "Овесена каша с протеин и боровинки", "Пилешко филе с ориз и броколи")
        - meal_type: Тип на храненето на английски (например: "breakfast", "morning_snack", "lunch", "afternoon_snack", "pre_workout_snack", "post_workout_snack", "dinner")
        - time: Препоръчително време за хранене във формат "HH:MM" (например: "07:00", "09:30")
        - description: Кратко описание на БЪЛГАРСКИ (2-3 изречения)
        - ingredients: Масив от съставки с name (на БЪЛГАРСКИ), quantity (число), unit (на БЪЛГАРСКИ като "г", "мл", "бр")
        - macros: Точни стойности за calories, protein, carbs, fats за цялото хранене
        - instructions: Масив от стъпки за приготвяне на БЪЛГАРСКИ
        - prep_time: Време за приготвяне в минути
        - cooking_time: Време за готвене в минути

        **ХРАНИТЕЛНИ СЪВЕТИ:**
        Предостави 3-5 УНИВЕРСАЛНИ и ПРАКТИЧНИ съвета, които са:
        - Приложими за всеки човек, независимо от целта
        - Фокусирани върху здравословни навици и хидратация
        - Кратки и лесни за запомняне (1-2 изречения максимум)
        - НЕ повтарят информация, която вече е включена в храненията

        ПРИМЕРИ за добри съвети:
        - "Пий поне 2.5-3 литра вода дневно - добра хидратация подобрява метаболизма и възстановяването."
        - "Спи 7-9 часа на нощ - качественият сън е ключов за хормоналния баланс и мускулното възстановяване."
        - "Приготвяй храната предварително - спестява време и те предпазва от нездравословни избори."
        - "Храни се бавно и осъзнато - отнема 15-20 минути на мозъка да регистрира ситост."

        НЕ давай съвети:
        - Повтарящи разпределението на макроси
        - Специфични корекции на калориите
        - Свързани с конкретни хранителни продукти (зеленчуци, месо, риба, плодове и т.н.)
        - Специфични за определена цел (cut, bulk, maintenance, recomposition и т.н.)
        - Технически детайли за предтренировъчни/следтренировъчни хранения
        - Времена на хранене или разпределение на макроси по време на деня
        - Съвети за следене на прогрес, тегло или телесни измервания

        **КРИТИЧНО ВАЖНО:**
        - Всички макроси са > 0 (освен carbs може да е 0)
        - МАКРОСИТЕ СА ИЗЧИСЛЕНИ ВЪЗ ОСНОВА НА РЕАЛНИТЕ ХРАНИТЕЛНИ СТОЙНОСТИ НА СЪСТАВКИТЕ - НЕ СА ИЗМИСЛЕНИ!
        - Математическата проверка (protein × 4) + (carbs × 4) + (fats × 9) ≈ calories МИНАВА за всяко хранене (±5% толеранс)
        - Дневните макроси за всеки ден са в допустимия диапазон
        - Макросите за всяко хранене трябва да са точни и сумата им да отговаря на дневните цели
        - meal_id е ВИНАГИ НА АНГЛИЙСКИ (например: 'chicken_salad', а не 'pileshka_salata')
        - ВСИЧКИ текстове (name, description, ingredients.name, instructions) трябва да са на БЪЛГАРСКИ
        - Избягвай думите 'предтренировъчно' и 'следтренировъчно' в ИМЕНАТА на ястията, знае се от meal_type.
        - Използвай само български единици: "г" (грама), "мл" (милилитри), "бр" (броя), "ч.л." (чаена лъжичка), "с.л." (супена лъжичка)
        - Предтренировъчното и следтренировъчното хранене са ЗАДЪЛЖИТЕЛНИ и трябва да са позиционирани правилно спрямо периода на тренировка - ${trainingPeriodBG}
        - Времената на храненията са логични и последователни
        - Няма отрицателни числа НИКЪДЕ
        - РАЗНООБРАЗИЕТО Е ЗАДЪЛЖИТЕЛНО - не повтаряй същите макроси!
        - СПАЗВАЙ ПРЕДПОЧИТАНИТЕ КУХНИ (${answers.cuisinePreference?.join(", ") || "разнообразни"}) - ястията трябва да отразяват избраната кухня!
        `;
}

function generateResponseFormat() {
  return {
    format: {
      type: "json_schema",
      name: "nutrition_plan",
      strict: true,
      schema: {
        type: "object",
        properties: {
          weekly_plan: {
            type: "array",
            items: {
              type: "object",
              properties: {
                day: {
                  type: "string",
                  pattern: "^Ден [1-7]$",
                  description: "Ден във формат 'Ден 1', 'Ден 2', и така нататък.",
                },
                total_macros: {
                  type: "object",
                  properties: {
                    calories: {
                      type: "number",
                      minimum: 1000,
                      description: "Общи калории за деня (ТРЯБВА да е положително число >= 1000)",
                    },
                    protein: {
                      type: "number",
                      minimum: 50,
                      description: "Общи протеини за деня в грамове (ТРЯБВА да е положително число >= 50)",
                    },
                    carbs: {
                      type: "number",
                      minimum: 0,
                      description: "Общи въглехидрати за деня в грамове (може да е 0 за кето)",
                    },
                    fats: {
                      type: "number",
                      minimum: 20,
                      description: "Общи мазнини за деня в грамове (ТРЯБВА да е положително число >= 20)",
                    },
                  },
                  required: ["calories", "protein", "carbs", "fats"],
                  additionalProperties: false,
                },
                meals: {
                  type: "array",
                  minItems: 5,
                  maxItems: 7,
                  items: {
                    type: "object",
                    properties: {
                      meal_id: {
                        type: "string",
                        pattern: "^[a-z]+(_[a-z]+)*$",
                        description: "Уникален идентификатор в единствено число с малки букви и долни черти",
                      },
                      name: {
                        type: "string",
                        minLength: 5,
                        description: "Име на рецептата на български (минимум 5 символа)",
                      },
                      meal_type: {
                        type: "string",
                        description: "Тип на храненето",
                        enum: [
                          "breakfast",
                          "morning_snack",
                          "lunch",
                          "afternoon_snack",
                          "pre_workout_snack",
                          "post_workout_snack",
                          "dinner",
                        ],
                      },
                      time: {
                        type: "string",
                        pattern: "^([0-1][0-9]|2[0-3]):[0-5][0-9]$",
                        description: "Време във формат HH:MM (24-часов формат)",
                      },
                      description: {
                        type: "string",
                        minLength: 20,
                        description: "Описание на български (минимум 20 символа)",
                      },
                      ingredients: {
                        type: "array",
                        minItems: 2,
                        items: {
                          type: "object",
                          properties: {
                            name: {
                              type: "string",
                              minLength: 2,
                              description: "Име на съставката на български",
                            },
                            quantity: {
                              type: "number",
                              minimum: 0.1,
                              description: "Количество (ТРЯБВА да е положително число > 0)",
                            },
                            unit: {
                              type: "string",
                              enum: ["г", "мл", "бр", "ч.л.", "с.л."],
                              description: "Мерна единица на български",
                            },
                          },
                          required: ["name", "quantity", "unit"],
                          additionalProperties: false,
                        },
                      },
                      macros: {
                        type: "object",
                        properties: {
                          calories: {
                            type: "number",
                            minimum: 100,
                            maximum: 1000,
                            description: "Калории за храненето (ТРЯБВА: 100-1000 kcal, положително число)",
                          },
                          protein: {
                            type: "number",
                            minimum: 5,
                            description: "Протеини в грамове (ТРЯБВА да е положително число >= 5)",
                          },
                          carbs: {
                            type: "number",
                            minimum: 0,
                            description: "Въглехидрати в грамове (може да е 0)",
                          },
                          fats: {
                            type: "number",
                            minimum: 2,
                            description: "Мазнини в грамове (ТРЯБВА да е положително число >= 2)",
                          },
                        },
                        required: ["calories", "protein", "carbs", "fats"],
                        additionalProperties: false,
                      },
                      instructions: {
                        type: "array",
                        minItems: 2,
                        items: {
                          type: "string",
                          minLength: 10,
                          description: "Стъпка от инструкциите на български (минимум 10 символа)",
                        },
                      },
                      prep_time: {
                        type: "number",
                        minimum: 0,
                        description: "Време за подготовка в минути (>= 0)",
                      },
                      cooking_time: {
                        type: "number",
                        minimum: 0,
                        description: "Време за готвене в минути (>= 0)",
                      },
                    },
                    required: [
                      "meal_id",
                      "name",
                      "meal_type",
                      "time",
                      "description",
                      "ingredients",
                      "macros",
                      "instructions",
                      "prep_time",
                      "cooking_time",
                    ],
                    additionalProperties: false,
                  },
                },
              },
              required: ["day", "total_macros", "meals"],
              additionalProperties: false,
            },
          },
          nutrition_tips: {
            type: "array",
            items: {
              type: "string",
              minLength: 20,
              description: "Хранителен съвет на български (минимум 20 символа)",
            },
            minItems: 3,
            maxItems: 5,
            description: "3-5 универсални хранителни съвета",
          },
        },
        required: ["weekly_plan", "nutrition_tips"],
        additionalProperties: false,
      },
    },
  };
}
